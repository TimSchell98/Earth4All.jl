<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Computing variable connections · Earth4all Documentation</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Earth4all Documentation</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Computing variable connections</a><ul class="internal"><li><a class="tocitem" href="#Summary"><span>Summary</span></a></li><li><a class="tocitem" href="#Prerequisites"><span>Prerequisites</span></a></li><li><a class="tocitem" href="#Functions-of-ModelingToolkit"><span>Functions of <code>ModelingToolkit</code></span></a></li><li><a class="tocitem" href="#Computing-the-variable-connections"><span>Computing the variable connections</span></a></li><li><a class="tocitem" href="#Tests"><span>Tests</span></a></li><li><a class="tocitem" href="#Side-effects"><span>Side effects</span></a></li></ul></li><li><a class="tocitem" href="../DELAY-N-comments/">Delay N comments</a></li><li><a class="tocitem" href="../Implementing-DELAY-N/">Implementing the DELAY N function</a></li><li><a class="tocitem" href="../Implementing-a-new-model/">Implementing a new model</a></li><li><a class="tocitem" href="../Technical-notes/">Technical notes</a></li><li><a class="tocitem" href="../The-Climate-sector/">The Climate sector</a></li><li><a class="tocitem" href="../The-Demand-sector/">The Demand sector</a></li><li><a class="tocitem" href="../The-Earth4All-model/">The Earth4All model</a></li><li><a class="tocitem" href="../The-Energy-sector/">The Energy sector</a></li><li><a class="tocitem" href="../The-Finance-sector/">The Finance sector</a></li><li><a class="tocitem" href="../The-Food-and-land-sector/">The Food and land sector</a></li><li><a class="tocitem" href="../The-Inventory-sector/">The Inventory sector</a></li><li><a class="tocitem" href="../The-Labour-market-sector/">The Labour market sector</a></li><li><a class="tocitem" href="../The-Other-performance-indicators-sector/">The Other performance indicators sector</a></li><li><a class="tocitem" href="../The-Output-sector/">The Output sector</a></li><li><a class="tocitem" href="../The-Population-sector/">The Population sector</a></li><li><a class="tocitem" href="../The-Public-sector/">The Public sector</a></li><li><a class="tocitem" href="../The-Wellbeing-sector/">The Wellbeing sector</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Computing variable connections</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Computing variable connections</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/worlddynamics/Earth4All/blob/master/docs/src/Computing-variable-connections.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Computing-variable-connections"><a class="docs-heading-anchor" href="#Computing-variable-connections">Computing variable connections</a><a id="Computing-variable-connections-1"></a><a class="docs-heading-anchor-permalink" href="#Computing-variable-connections" title="Permalink"></a></h1><h2 id="Summary"><a class="docs-heading-anchor" href="#Summary">Summary</a><a id="Summary-1"></a><a class="docs-heading-anchor-permalink" href="#Summary" title="Permalink"></a></h2><p>In this memorandum, we will explain how we can compute automatically the variable connections of a scenario (that is, a collection of ODE systems). This method is currently implemented in the function <code>variable_connections</code>, which is now included in the file <code>solvesystems.jl</code>.</p><h2 id="Prerequisites"><a class="docs-heading-anchor" href="#Prerequisites">Prerequisites</a><a id="Prerequisites-1"></a><a class="docs-heading-anchor-permalink" href="#Prerequisites" title="Permalink"></a></h2><p>We assume that each variable is defined in exactly one ODE system: that is, each variable appears in exactly one Left-Hand Side (in short, LHS) of an equation of an ODE system. Moreover, if a variable appears in the Right-Hand Side (in short, RHS) of an equation of an ODE system, then it has the same name as the one used in the ODE system in which the variable is defined.</p><h2 id="Functions-of-ModelingToolkit"><a class="docs-heading-anchor" href="#Functions-of-ModelingToolkit">Functions of <code>ModelingToolkit</code></a><a id="Functions-of-ModelingToolkit-1"></a><a class="docs-heading-anchor-permalink" href="#Functions-of-ModelingToolkit" title="Permalink"></a></h2><p>We will make use of the following two functions, which are available in the package <code>ModelingToolkit</code>.</p><ul><li><code>variable_dependencies</code>. For each variable in the input system, this function determines the equations that modify it, that is, in which the variable appears in the LHS of the equation. The function returns this information as a bipartite graph.</li><li><code>equation_dependencies</code>. This function calculates, for each equation in the input system, the variables it depends on. The function returns a vector of vectors of variables.</li></ul><p>\end{itemize}</p><h2 id="Computing-the-variable-connections"><a class="docs-heading-anchor" href="#Computing-the-variable-connections">Computing the variable connections</a><a id="Computing-the-variable-connections-1"></a><a class="docs-heading-anchor-permalink" href="#Computing-the-variable-connections" title="Permalink"></a></h2><p>Given a vector <code>systems</code> of ODE systems, the function <code>variable_connections</code> first compose all the systems into a single ODE system.</p><pre><code class="language-jl hljs">@variables t
@named _model = ODESystem([], t)
@named model = ModelingToolkit.compose(_model, systems)</code></pre><p>It then initialises the set of variable connection equations, the dictionary mapping each variable name to the name of the <em>unique</em> ODE system in which the variable is modified, and the dictionary mapping each variable name to its full name (that is, its name preceded by the name of the unique ODE system in which the variable is modified and separated by the symbol <span>$_+$</span>).</p><pre><code class="language-jl hljs">connection_eqs::Set{Equation} = Set{Equation}()
var2sys::Dict{String,String} = Dict{String,String}()
var2fullvar = Dict()</code></pre><p>By using the function <code>variable_dependencies</code>, the adjacency list of each node of the resulting bipartite graph is examined. This adjacency list contains exactly one element, whenever the corresponding variable has been defined in the corresponding system. In this case, we deduce the name of the system from the full name of the variable, and we save this information in the two dictionaries.</p><pre><code class="language-jl hljs">g = variable_dependencies(model)
al = g.fadjlist
for u in 1:lastindex(al)
    if (length(al[u]) == 1)
        s, v = split(string(states(model)[u]), &quot;$_+$&quot;)
        var2sys[v] = s
        var2fullvar[v] = states(model)[u]
    end
end</code></pre><p>By using the function <code>equation_dependencies</code>, for each equation we examine the vector of the full names of the variables it depends on. For each such full name, we deduce from it the name of the corresponding system: if it is not the the unique system in which the variable is defined, then we add the variable connection equation to the set of all variable connection equations.</p><pre><code class="language-jl hljs">ed = equation_dependencies(model)
for u in 1:lastindex(ed)
    vl = ed[u]
    for v in 1:lastindex(vl)
        subs, var = split(string(vl[v]), &quot;$_+$&quot;)
        if (var2sys[var] != subs)
            push!(connection_eqs, vl[v] ~ var2fullvar[var])
        end
    end
end</code></pre><p>Finally, we return the collection of all the variable connection equations.</p><pre><code class="language-jl hljs">return collect(connection_eqs)</code></pre><h2 id="Tests"><a class="docs-heading-anchor" href="#Tests">Tests</a><a id="Tests-1"></a><a class="docs-heading-anchor-permalink" href="#Tests" title="Permalink"></a></h2><p>The function has been tested in the case of the scenario <code>historicalrun</code> of the <code>World3</code> model and in the case of the scenario <code>natural_resource_depletion</code> of the <code>World2</code> model. In both cases, we have tested that the vector of variable connection equations was the same as the one in the current distribution of <code>WorldDynamics</code>. We also included a test on some small and simple ODE systems.</p><h2 id="Side-effects"><a class="docs-heading-anchor" href="#Side-effects">Side effects</a><a id="Side-effects-1"></a><a class="docs-heading-anchor-permalink" href="#Side-effects" title="Permalink"></a></h2><p>While testing the function in the case of the <code>World3</code> model, we realized that one variable connection equation, that is, <code>ppgf22 ~ 1.0</code>, is indeed an algebraic equation to be put in an ODE subsystem of the pollution system. To this aim, we added a subsystem to the pollution system, called <code>persistent_pollution_dummy</code>, which contains only this equation.</p><pre><code class="language-jl hljs">function persistent_pollution_dummy(; name, params=_params, inits=_inits, tables=_tables, ranges=_ranges)
    @variables ppgf22(t)
    eqs = [ppgf22 ~ 1.0]
    ODESystem(eqs; name)
end</code></pre><p>Clearly, this subsystem has to be added to the scenario <code>historicalrun</code> as follows.</p><pre><code class="language-jl hljs">@named ppd = Pollution.persistent_pollution_dummy(; params=pollution_params, inits=pollution_inits, tables=pollution_tables, ranges=pollution_ranges)</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../DELAY-N-comments/">Delay N comments »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Wednesday 24 May 2023 21:57">Wednesday 24 May 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
