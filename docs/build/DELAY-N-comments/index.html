<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Delay N comments · Earth4all Documentation</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Earth4all Documentation</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../Computing-variable-connections/">Computing variable connections</a></li><li class="is-active"><a class="tocitem" href>Delay N comments</a><ul class="internal"><li><a class="tocitem" href="#Summary"><span>Summary</span></a></li><li><a class="tocitem" href="#First-order-delay"><span>First order delay</span></a></li><li><a class="tocitem" href="#Third-order-delay"><span>Third order delay</span></a></li><li><a class="tocitem" href="#Final-observation"><span>Final observation</span></a></li></ul></li><li><a class="tocitem" href="../Implementing-DELAY-N/">Implementing the DELAY N function</a></li><li><a class="tocitem" href="../Implementing-a-new-model/">Implementing a new model</a></li><li><a class="tocitem" href="../Technical-notes/">Technical notes</a></li><li><a class="tocitem" href="../The-Climate-sector/">The Climate sector</a></li><li><a class="tocitem" href="../The-Demand-sector/">The Demand sector</a></li><li><a class="tocitem" href="../The-Earth4All-model/">The Earth4All model</a></li><li><a class="tocitem" href="../The-Energy-sector/">The Energy sector</a></li><li><a class="tocitem" href="../The-Finance-sector/">The Finance sector</a></li><li><a class="tocitem" href="../The-Food-and-land-sector/">The Food and land sector</a></li><li><a class="tocitem" href="../The-Inventory-sector/">The Inventory sector</a></li><li><a class="tocitem" href="../The-Labour-market-sector/">The Labour market sector</a></li><li><a class="tocitem" href="../The-Other-performance-indicators-sector/">The Other performance indicators sector</a></li><li><a class="tocitem" href="../The-Output-sector/">The Output sector</a></li><li><a class="tocitem" href="../The-Population-sector/">The Population sector</a></li><li><a class="tocitem" href="../The-Public-sector/">The Public sector</a></li><li><a class="tocitem" href="../The-Wellbeing-sector/">The Wellbeing sector</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Delay N comments</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Delay N comments</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/worlddynamics/Earth4All/blob/master/docs/src/DELAY-N-comments.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Delay-N-comments"><a class="docs-heading-anchor" href="#Delay-N-comments">Delay N comments</a><a id="Delay-N-comments-1"></a><a class="docs-heading-anchor-permalink" href="#Delay-N-comments" title="Permalink"></a></h1><h2 id="Summary"><a class="docs-heading-anchor" href="#Summary">Summary</a><a id="Summary-1"></a><a class="docs-heading-anchor-permalink" href="#Summary" title="Permalink"></a></h2><p>The implementation of the function <code>DELAY N</code> with variable delay is more complicated than expected. In this memorandum, we will try to explain the main problems that we still have to solve in order to get the correct implementation of <code>DELAY N</code> of order 1 and 3.</p><h2 id="First-order-delay"><a class="docs-heading-anchor" href="#First-order-delay">First order delay</a><a id="First-order-delay-1"></a><a class="docs-heading-anchor-permalink" href="#First-order-delay" title="Permalink"></a></h2><p>The following is the definition of <code>DELAY1</code> given in the <code>Vensim</code> documentation, which hopefully should give us some hints on how to implement <code>DELAY N</code> of first order with variable delay.</p><pre><code class="language-jl hljs">    DELAY1=LV/delay
    LV=INTEG(input-DELAY1,input*delay)</code></pre><h3 id="Two-implementations"><a class="docs-heading-anchor" href="#Two-implementations">Two implementations</a><a id="Two-implementations-1"></a><a class="docs-heading-anchor-permalink" href="#Two-implementations" title="Permalink"></a></h3><p>Assuming that <span>$\mathtt{input}(t) = t$</span> (that is, a straight line) and that <span>$\mathtt{delay}(t) = \sqrt{1+\mathtt{input}(t)}$</span> (in order to have a positive relatively small varying delay), we can implement this function through an ODE system in two different ways.</p><ol><li>We translate the above two equations by substituting the <code>DELAY1</code> expression into the last ODE. We thus obtain the following set of equations.</li></ol><pre><code class="language-jl hljs">    D(input) ~ 1
    delay ~ sqrt(1+input)
    DELAY1 ~ LV/delay
    D(LV) ~ input-LV/delay</code></pre><p>We call this approach the <em>LV approach</em> since it consists in specifying the derivative of <code>LV</code> and deriving the value of <code>DELAY1</code> from the value of <code>LV</code>.</p><ol><li>We translate the above two equations by specifying the derivative of <code>DELAY1</code> and by using the derivative of <code>LV</code> <em>and</em> of <code>delay time</code>. Indeed, we have that</li></ol><p class="math-container">\[\begin{align*}
D(\mathtt{DELAY1}) &amp; = D(\mathtt{LV}/\mathtt{delay})\\
&amp; = \frac{1}{\mathtt{delay}^2}(D(\mathtt{LV})\cdot\mathtt{delay}-\mathtt{LV}\cdot D(\mathtt{delay}))\\
&amp; = \frac{1}{\mathtt{delay}^2}((\mathtt{input}-\mathtt{DELAY1})\cdot\mathtt{delay}-\mathtt{LV}\cdot D(\mathtt{delay}))\\
&amp; = \frac{1}{\mathtt{delay}^2}((\mathtt{input}-\mathtt{DELAY1})\cdot\mathtt{delay}-(\mathtt{delay}\cdot\mathtt{DELAY1})D(\mathtt{delay}))\\
&amp; = \frac{1}{\mathtt{delay}}(\mathtt{input}-\mathtt{DELAY1}-\mathtt{DELAY1}\cdot D(\mathtt{delay}))\\
&amp; = \frac{1}{\mathtt{delay}}(\mathtt{input}-\mathtt{DELAY1}(1+D(\mathtt{delay})))
\end{align*}\]</p><p>We thus obtain the following set of equations (note that we have only three equations but the derivative of the delay is present in the right-hand side of the third equation).</p><pre><code class="language-jl hljs">    D(input) ~ 1
    delay ~ sqrt(1+input)
    D(DELAY1) ~ (1/delay)*(input-DELAY1*(1+D(delay)))</code></pre><p>We call this approach the <em>RT approach</em> since, as we will see in the case of order <span>$3$</span>, it consists in specifying the derivative of two variables <code>RT1</code> and <code>RT2</code> and the derivative of <code>DELAY1</code> (in the case of order <span>$1$</span> we have only this latter variable).</p><h3 id="Different-results"><a class="docs-heading-anchor" href="#Different-results">Different results</a><a id="Different-results-1"></a><a class="docs-heading-anchor-permalink" href="#Different-results" title="Permalink"></a></h3><p>The two above approaches are not equivalent. Indeed, by using the Euler method with time step equal to <span>$0.25$</span> and with a time span equal to <span>$(0,100)$</span>, the value of <code>DELAY1</code> in the solution obtained with the LV approach is always a little bit smaller than the value of <code>DELAY1</code> in the solution obtained with the RT approach. This difference increases until the <span>$18$</span>-th step (when it is approximately equal to <span>$0.026$</span>) and then decreases and reaches the value <span>$0.008820625$</span>. Moreover, the value of <code>DELAY1</code> in the solution obtained with the RT approach is closer to the value of <code>DELAY1</code> given by using the function <code>DELAY N</code> of order <span>$1$</span> in <code>Vensim</code>, while the value of <code>DELAY1</code> in the solution obtained with the LV approach is almost exactly equal to the value of <code>DELAY1</code> given by using the function <code>DELAY1</code> in <code>Vensim</code>. This suggests that the RT approach is closer to the correct implementation of the function <code>DELAY N</code> of order <span>$1$</span> with variable delay.</p><h2 id="Third-order-delay"><a class="docs-heading-anchor" href="#Third-order-delay">Third order delay</a><a id="Third-order-delay-1"></a><a class="docs-heading-anchor-permalink" href="#Third-order-delay" title="Permalink"></a></h2><p>The following is the definition of <code>DELAY3</code> given in the <code>Vensim</code> documentation.</p><pre><code class="language-jl hljs">    DELAY3=LV3/DL
    LV3=INTEG(RT2-DELAY3,DL*input)
    RT2=LV2/DL
    LV2=INTEG(RT1-RT2,LV3)
    RT1=LV1/DL
    LV1=INTEG(input-RT1,LV3)
    DL=delay/3</code></pre><p>By following the two previously described approaches, we obtain the following two sets of equations, respectively.</p><ol><li>LV approach.</li></ol><pre><code class="language-jl hljs">    D(input) ~ 1
    delay ~ sqrt(1+input)
    DELAY3 ~ (3/delay)*LV3
    D(LV3) ~ (3*LV2/delay)-DELAY3
    D(LV2) ~ (3*LV1/delay)-(3*LV2/delay)
    D(LV1) ~ input-3*LV1/delay</code></pre><ol><li>RT approach.</li></ol><pre><code class="language-jl hljs">    D(input) ~ 1
    delay ~ sqrt(1+input)
    D(DELAY3) ~ (3/delay)*(RT2-DELAY3*(1+D(delay)/3))
    D(RT2) ~ (3/delay)*(RT1-RT2*(1+D(delay)/3))
    D(RT1) ~ (3/delay)*(input-RT1*(1+D(delay)/3))</code></pre><p>Once again, the two above approaches are not equivalent. However, the value of <code>DELAY1</code> in the solution obtained with the RT approach is less close to the value of <code>DELAY1</code> given by using the function <code>DELAY N</code> of order <span>$3$</span> in <code>Vensim</code>, while the value of <code>DELAY1</code> in the solution obtained with the LV approach is almost exactly equal to the value of <code>DELAY1</code> given by using the function <code>DELAY3</code> in <code>Vensim</code>. This suggests that the two approaches are still not the correct implementation of the function <code>DELAY N</code> of order <span>$3$</span> with variable delay.</p><h2 id="Final-observation"><a class="docs-heading-anchor" href="#Final-observation">Final observation</a><a id="Final-observation-1"></a><a class="docs-heading-anchor-permalink" href="#Final-observation" title="Permalink"></a></h2><p>Both approaches seem to generates errors when applied to the <code>Earth4All</code> model. It might be that this is due to some programming error, but we suspect that it is due to the fact that we are using the derivative of the delay in the right hand side of several ODEs.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Computing-variable-connections/">« Computing variable connections</a><a class="docs-footer-nextpage" href="../Implementing-DELAY-N/">Implementing the DELAY N function »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Wednesday 24 May 2023 21:57">Wednesday 24 May 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
